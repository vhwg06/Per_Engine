namespace PerformanceEngine.Evaluation.Domain.Tests.Application;

public class DtoTests
{
    [Fact]
    public void RuleDto_FromDomain_ThresholdRule_MapsCorrectly()
    {
        // Arrange
        var domainRule = new ThresholdRule
        {
            Id = "threshold-1",
            Name = "P95 Threshold",
            Description = "P95 should be less than 200ms",
            AggregationName = "P95",
            Threshold = 200.0,
            Operator = ComparisonOperator.LessThan,
            Severity = Severity.FAIL
        };

        // Act
        var dto = RuleDto.FromDomain(domainRule);

        // Assert
        dto.Should().NotBeNull();
        dto.Id.Should().Be("threshold-1");
        dto.Name.Should().Be("P95 Threshold");
        dto.Description.Should().Be("P95 should be less than 200ms");
        dto.RuleType.Should().Be("Threshold");
        dto.Configuration.Should().ContainKey("AggregationName");
        dto.Configuration.Should().ContainKey("Threshold");
        dto.Configuration.Should().ContainKey("Operator");
        dto.Configuration["AggregationName"].Should().Be("P95");
    }

    [Fact]
    public void RuleDto_FromDomain_RangeRule_MapsCorrectly()
    {
        // Arrange
        var domainRule = new RangeRule
        {
            Id = "range-1",
            Name = "Error Rate Range",
            Description = "Error rate between 0% and 5%",
            AggregationName = "ErrorRate",
            MinBound = 0.0,
            MaxBound = 5.0,
            Severity = Severity.WARN
        };

        // Act
        var dto = RuleDto.FromDomain(domainRule);

        // Assert
        dto.Should().NotBeNull();
        dto.Id.Should().Be("range-1");
        dto.Name.Should().Be("Error Rate Range");
        dto.RuleType.Should().Be("Range");
        dto.Configuration.Should().ContainKey("MinBound");
        dto.Configuration.Should().ContainKey("MaxBound");
        dto.Configuration["MinBound"].Should().Be("0");
        dto.Configuration["MaxBound"].Should().Be("5");
    }

    [Fact]
    public void RuleDto_ToDomain_ThresholdRule_ReconstructsCorrectly()
    {
        // Arrange
        var dto = new RuleDto
        {
            Id = "threshold-dto",
            Name = "Test Threshold",
            Description = "Test description",
            RuleType = "Threshold",
            Configuration = new Dictionary<string, string>
            {
                { "AggregationName", "P99" },
                { "Threshold", "500" },
                { "Operator", "LessThan" },
                { "Severity", "FAIL" }
            }
        };

        // Act
        var domainRule = dto.ToDomain();

        // Assert
        domainRule.Should().NotBeNull();
        domainRule.Should().BeOfType<ThresholdRule>();
        var thresholdRule = domainRule as ThresholdRule;
        thresholdRule!.Id.Should().Be("threshold-dto");
        thresholdRule.AggregationName.Should().Be("P99");
        thresholdRule.Threshold.Should().Be(500.0);
        thresholdRule.Operator.Should().Be(ComparisonOperator.LessThan);
    }

    [Fact]
    public void RuleDto_ToDomain_RangeRule_ReconstructsCorrectly()
    {
        // Arrange
        var dto = new RuleDto
        {
            Id = "range-dto",
            Name = "Test Range",
            Description = "Test range description",
            RuleType = "Range",
            Configuration = new Dictionary<string, string>
            {
                { "AggregationName", "Throughput" },
                { "MinBound", "100" },
                { "MaxBound", "1000" },
                { "Severity", "WARN" }
            }
        };

        // Act
        var domainRule = dto.ToDomain();

        // Assert
        domainRule.Should().NotBeNull();
        domainRule.Should().BeOfType<RangeRule>();
        var rangeRule = domainRule as RangeRule;
        rangeRule!.Id.Should().Be("range-dto");
        rangeRule.AggregationName.Should().Be("Throughput");
        rangeRule.MinBound.Should().Be(100.0);
        rangeRule.MaxBound.Should().Be(1000.0);
    }

    [Fact]
    public void ViolationDto_FromDomain_MapsCorrectly()
    {
        // Arrange
        var domainViolation = Violation.Create(
            ruleId: "rule-1",
            metricName: "P95",
            actualValue: 250.0,
            threshold: 200.0,
            message: "P95 latency exceeded threshold"
        );

        // Act
        var dto = ViolationDto.FromDomain(domainViolation);

        // Assert
        dto.Should().NotBeNull();
        dto.RuleId.Should().Be("rule-1");
        dto.MetricName.Should().Be("P95");
        dto.ActualValue.Should().Be(250.0);
        dto.Threshold.Should().Be(200.0);
        dto.Message.Should().Be("P95 latency exceeded threshold");
    }

    [Fact]
    public void ViolationDto_ToDomain_ReconstructsCorrectly()
    {
        // Arrange
        var dto = new ViolationDto
        {
            RuleId = "rule-2",
            MetricName = "ErrorRate",
            ActualValue = 2.5,
            Threshold = 1.0,
            Message = "Error rate too high"
        };

        // Act
        var domainViolation = dto.ToDomain();

        // Assert
        domainViolation.Should().NotBeNull();
        domainViolation.RuleId.Should().Be("rule-2");
        domainViolation.MetricName.Should().Be("ErrorRate");
        domainViolation.ActualValue.Should().Be(2.5);
        domainViolation.Threshold.Should().Be(1.0);
        domainViolation.Message.Should().Be("Error rate too high");
    }

    [Fact]
    public void EvaluationResultDto_FromDomain_Pass_MapsCorrectly()
    {
        // Arrange
        var domainResult = EvaluationResult.Pass();

        // Act
        var dto = EvaluationResultDto.FromDomain(domainResult);

        // Assert
        dto.Should().NotBeNull();
        dto.Outcome.Should().Be("PASS");
        dto.Violations.Should().BeEmpty();
        dto.EvaluatedAt.Should().NotBeNullOrEmpty();
    }

    [Fact]
    public void EvaluationResultDto_FromDomain_Fail_MapsCorrectly()
    {
        // Arrange
        var violation = Violation.Create(
            ruleId: "rule-fail",
            metricName: "P99",
            actualValue: 600.0,
            threshold: 500.0,
            message: "P99 exceeded"
        );

        var domainResult = EvaluationResult.Fail(new[] { violation });

        // Act
        var dto = EvaluationResultDto.FromDomain(domainResult);

        // Assert
        dto.Should().NotBeNull();
        dto.Outcome.Should().Be("FAIL");
        dto.Violations.Should().HaveCount(1);
        dto.Violations[0].RuleId.Should().Be("rule-fail");
        dto.Violations[0].ActualValue.Should().Be(600.0);
    }

    [Fact]
    public void EvaluationResultDto_FromDomain_Warning_MapsCorrectly()
    {
        // Arrange
        var violation = Violation.Create(
            ruleId: "rule-warn",
            metricName: "Throughput",
            actualValue: 50.0,
            threshold: 100.0,
            message: "Throughput low"
        );

        var domainResult = EvaluationResult.Warning(new[] { violation });

        // Act
        var dto = EvaluationResultDto.FromDomain(domainResult);

        // Assert
        dto.Should().NotBeNull();
        dto.Outcome.Should().Be("WARN");
        dto.Violations.Should().HaveCount(1);
    }

    [Fact]
    public void EvaluationResultDto_ToDomain_ReconstructsCorrectly()
    {
        // Arrange
        var dto = new EvaluationResultDto
        {
            Outcome = "FAIL",
            Violations = new List<ViolationDto>
            {
                new ViolationDto
                {
                    RuleId = "rule-dto",
                    MetricName = "P95",
                    ActualValue = 300.0,
                    Threshold = 200.0,
                    Message = "P95 too high"
                }
            },
            EvaluatedAt = DateTime.UtcNow.ToString("O")
        };

        // Act
        var domainResult = dto.ToDomain();

        // Assert
        domainResult.Should().NotBeNull();
        domainResult.Outcome.Should().Be(Severity.FAIL);
        domainResult.Violations.Should().HaveCount(1);
        domainResult.Violations[0].RuleId.Should().Be("rule-dto");
        domainResult.Violations[0].ActualValue.Should().Be(300.0);
    }

    [Fact]
    public void BatchEvaluationDto_FromDomain_MapsCorrectly()
    {
        // Arrange
        var results = new[]
        {
            EvaluationResult.Pass(),
            EvaluationResult.Fail(new[]
            {
                Violation.Create("rule-1", "P95", 250.0, 200.0, "Failed")
            })
        };

        // Act
        var dto = BatchEvaluationResultDto.FromDomain(results);

        // Assert
        dto.Should().NotBeNull();
        dto.Results.Should().HaveCount(2);
        dto.Summary.Total.Should().Be(2);
        dto.Summary.Passed.Should().Be(1);
        dto.Summary.Failed.Should().Be(1);
        dto.Summary.TotalViolations.Should().Be(1);
    }

    [Fact]
    public void BatchEvaluationDto_Summary_CalculatesCorrectly()
    {
        // Arrange
        var results = new[]
        {
            EvaluationResult.Pass(),
            EvaluationResult.Pass(),
            EvaluationResult.Warning(new[]
            {
                Violation.Create("rule-w", "Metric", 100.0, 90.0, "Warning")
            }),
            EvaluationResult.Fail(new[]
            {
                Violation.Create("rule-f1", "P95", 250.0, 200.0, "Fail1"),
                Violation.Create("rule-f2", "P99", 600.0, 500.0, "Fail2")
            })
        };

        // Act
        var dto = BatchEvaluationResultDto.FromDomain(results);

        // Assert
        dto.Summary.Total.Should().Be(4);
        dto.Summary.Passed.Should().Be(2);
        dto.Summary.Warnings.Should().Be(1);
        dto.Summary.Failed.Should().Be(1);
        dto.Summary.TotalViolations.Should().Be(3);
    }

    [Fact]
    public void RuleDto_RoundTrip_ThresholdRule_PreservesData()
    {
        // Arrange
        var original = new ThresholdRule
        {
            Id = "roundtrip-1",
            Name = "Round Trip Test",
            Description = "Test round trip",
            AggregationName = "P95",
            Threshold = 150.0,
            Operator = ComparisonOperator.GreaterThan,
            Severity = Severity.WARN
        };

        // Act
        var dto = RuleDto.FromDomain(original);
        var reconstructed = dto.ToDomain() as ThresholdRule;

        // Assert
        reconstructed.Should().NotBeNull();
        reconstructed!.Id.Should().Be(original.Id);
        reconstructed.Name.Should().Be(original.Name);
        reconstructed.AggregationName.Should().Be(original.AggregationName);
        reconstructed.Threshold.Should().Be(original.Threshold);
        reconstructed.Operator.Should().Be(original.Operator);
    }

    [Fact]
    public void ViolationDto_RoundTrip_PreservesData()
    {
        // Arrange
        var original = Violation.Create(
            ruleId: "roundtrip-violation",
            metricName: "ErrorRate",
            actualValue: 3.5,
            threshold: 1.0,
            message: "Error rate violation"
        );

        // Act
        var dto = ViolationDto.FromDomain(original);
        var reconstructed = dto.ToDomain();

        // Assert
        reconstructed.RuleId.Should().Be(original.RuleId);
        reconstructed.MetricName.Should().Be(original.MetricName);
        reconstructed.ActualValue.Should().Be(original.ActualValue);
        reconstructed.Threshold.Should().Be(original.Threshold);
        reconstructed.Message.Should().Be(original.Message);
    }

    [Fact]
    public void EvaluationResultDto_RoundTrip_PreservesOutcome()
    {
        // Arrange
        var violations = new[]
        {
            Violation.Create("rule-a", "Metric-A", 100.0, 90.0, "Violation A"),
            Violation.Create("rule-b", "Metric-B", 200.0, 180.0, "Violation B")
        };
        var original = EvaluationResult.Fail(violations);

        // Act
        var dto = EvaluationResultDto.FromDomain(original);
        var reconstructed = dto.ToDomain();

        // Assert
        reconstructed.Outcome.Should().Be(original.Outcome);
        reconstructed.Violations.Should().HaveCount(original.Violations.Count);
        reconstructed.Violations[0].RuleId.Should().Be(original.Violations[0].RuleId);
        reconstructed.Violations[1].RuleId.Should().Be(original.Violations[1].RuleId);
    }
}
